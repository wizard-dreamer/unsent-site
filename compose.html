<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Compose — The Words Left Unsent</title>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=Special+Elite&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: { primary: "#6B8EAD", "background-dark": "#0f1220" },
        fontFamily: { display: ["Plus Jakarta Sans","sans-serif"], typewriter: ["Special Elite","monospace"] }
      }
    }
  }
</script>

<style>
  :root { --card-radius: 14px; }
  body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .compose-textarea {
    font-family: 'Special Elite', monospace;
    font-size: 16px;
    line-height: 1.6;
    background-color: rgba(255,255,255,0.02);
    color: #e6eef6;
    border: 1px solid rgba(255,255,255,0.05);
    padding: 18px;
    border-radius: 12px;
    resize: none;
    min-height: 220px;
    max-height: 60vh;
    width: 100%;
    box-sizing: border-box;
  }
  .recipient-btn, .mood-label { transition: transform .12s ease, box-shadow .12s ease, background .12s ease; }
  .recipient-btn.active { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.06); }
  .mood-label.active { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.4); border-color: var(--mood-accent,#6B8EAD); }
  .page-wrap { max-width: 920px; margin: 0 auto; }
  .muted { color: #9aa0b4; }
  @media (max-width:420px){ .compose-textarea { padding:14px; font-size:15px; min-height:180px; } }
</style>
</head>

<body class="bg-background-dark text-white font-display">
  <div class="min-h-screen px-4 py-8 sm:py-12">
    <div class="page-wrap">
      <div class="text-center mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold">Unsent • Confessional</h1>
        <p class="text-sm muted mt-1">Write what you can’t say aloud — short, safe, and honest.</p>
      </div>

      <main class="bg-[rgba(8,11,20,0.6)] border border-white/6 rounded-2xl p-5 sm:p-7 shadow-xl">
        <textarea id="txtBody" class="compose-textarea" placeholder="Let your thoughts flow here..." aria-label="Write your whisper"></textarea>

        <div class="mt-5 grid grid-cols-1 gap-5 md:grid-cols-2">
          <!-- Left: recipient + anonymity -->
          <div class="space-y-4">
            <div>
              <label class="text-sm font-semibold">Recipient</label>
              <div class="mt-3 flex flex-wrap gap-2">
                <button type="button" data-recipient="To myself" class="recipient-btn rounded-md border border-white/6 px-3 py-2 text-sm">To myself</button>
                <button type="button" data-recipient="A lost friend" class="recipient-btn rounded-md border border-white/6 px-3 py-2 text-sm">A lost friend</button>
                <button type="button" data-recipient="The void" class="recipient-btn rounded-md border border-white/6 px-3 py-2 text-sm">The void</button>
              </div>
              <input id="customRecipient" class="mt-3 w-full rounded-md border border-white/6 px-3 py-2 bg-transparent text-sm" placeholder="Or type custom recipient (optional)" aria-label="Custom recipient" />
            </div>

            <div>
              <label class="text-sm font-semibold">Anonymity</label>
              <div class="mt-2 flex items-center gap-3">
                <label class="inline-flex items-center gap-2 cursor-pointer">
                  <input id="chkAnon" type="checkbox" checked class="h-4 w-4" />
                  <span class="text-sm">Remain anonymous</span>
                </label>
                <span class="text-xs muted">— You can add a name later</span>
              </div>
            </div>
          </div>

          <!-- Right: mood + preview -->
          <div class="space-y-4">
            <div>
              <label class="text-sm font-semibold">Mood</label>
              <div class="mt-3 grid grid-cols-4 gap-2">
                <label class="mood-label flex cursor-pointer flex-col items-center gap-1 rounded-md border border-white/6 p-2 text-xs" data-mood="hope" style="--mood-accent:#FFD166">
                  <input name="mood" value="hope" type="radio" class="sr-only">
                  <span class="material-symbols-outlined text-lg">sentiment_very_satisfied</span>
                  <span>Hope</span>
                </label>

                <label class="mood-label active flex cursor-pointer flex-col items-center gap-1 rounded-md border border-primary p-2 text-xs" data-mood="melancholy" style="--mood-accent:#6B8EAD">
                  <input name="mood" value="melancholy" type="radio" checked class="sr-only">
                  <span class="material-symbols-outlined text-lg">sentiment_sad</span>
                  <span>Melancholy</span>
                </label>

                <label class="mood-label flex cursor-pointer flex-col items-center gap-1 rounded-md border border-white/6 p-2 text-xs" data-mood="anger" style="--mood-accent:#EF476F">
                  <input name="mood" value="anger" type="radio" class="sr-only">
                  <span class="material-symbols-outlined text-lg">sentiment_very_dissatisfied</span>
                  <span>Anger</span>
                </label>

                <label class="mood-label flex cursor-pointer flex-col items-center gap-1 rounded-md border border-white/6 p-2 text-xs" data-mood="love" style="--mood-accent:#FFB4C0">
                  <input name="mood" value="love" type="radio" class="sr-only">
                  <span class="material-symbols-outlined text-lg">favorite</span>
                  <span>Love</span>
                </label>
              </div>
            </div>

            <div>
              <label class="text-sm font-semibold">Preview</label>
              <div id="preview" class="mt-2 min-h-[72px] rounded-md border border-white/6 p-3 text-sm font-serif bg-[rgba(255,255,255,0.02)]">Your whisper preview...</div>
            </div>
          </div>
        </div>

        <div class="mt-5 flex items-center justify-between gap-3">
          <button id="btnCancel" class="rounded-md border border-white/6 px-4 py-2 text-sm">Cancel</button>
          <div class="flex items-center gap-3">
            <button id="btnSave" class="rounded-md bg-primary px-4 py-2 text-sm font-semibold text-white shadow">Whisper</button>
          </div>
        </div>

        <p id="statusMsg" class="mt-3 text-xs muted flex items-center gap-2"><span class="material-symbols-outlined text-xs">info</span> Posts will be published publicly if Firestore is configured; otherwise saved locally on this device for testing.</p>
      </main>
    </div>
  </div>

<!-- Optional Firebase SDKs (already included if you pasted config earlier) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* -------------------------
  FIREBASE CONFIG
  If you already placed config elsewhere, this will connect.
  Replace the firebaseConfig object with your project's config if needed.
------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyB-28iKKBChtAulr91LtBULeY3qCSfLoDk",
  authDomain: "the-words-left-unsent.firebaseapp.com",
  projectId: "the-words-left-unsent",
  storageBucket: "the-words-left-unsent.firebasestorage.app",
  messagingSenderId: "924610897130",
  appId: "1:924610897130:web:a940973a3e27caba1f6393",
  measurementId: "G-VK8QTYGSEE"
};

let firestoreAvailable = false;
try {
  if (window.firebase && firebase.apps && firebase.apps.length) {
    // already initialized externally
    firestoreAvailable = !!(firebase && firebase.firestore);
  } else {
    firebase.initializeApp(firebaseConfig);
    firestoreAvailable = !!(firebase && firebase.firestore);
  }
} catch (e) {
  console.warn('Firebase init skipped or failed:', e);
  firestoreAvailable = !!(window.firebase && firebase.firestore);
}

const KEY_LOCAL = 'unsent_posts_v1_local';
const txtBody = document.getElementById('txtBody');
const recipientBtns = Array.from(document.querySelectorAll('.recipient-btn'));
const customRecipient = document.getElementById('customRecipient');
const chkAnon = document.getElementById('chkAnon');
const moodLabels = Array.from(document.querySelectorAll('.mood-label'));
const moodRadios = Array.from(document.querySelectorAll('input[name="mood"]'));
const preview = document.getElementById('preview');
const btnSave = document.getElementById('btnSave');
const btnCancel = document.getElementById('btnCancel');
const statusMsg = document.getElementById('statusMsg');

function autosize(el){
  el.style.height = 'auto';
  el.style.height = Math.min(window.innerHeight * 0.6, el.scrollHeight + 8) + 'px';
}
txtBody.addEventListener('input', () => { autosize(txtBody); updatePreview(); });
autosize(txtBody);

// recipient buttons behaviour
recipientBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    recipientBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    customRecipient.value = btn.dataset.recipient || btn.textContent.trim();
  });
  if (!btn.dataset.recipient && btn.getAttribute('data-recipient')) btn.dataset.recipient = btn.getAttribute('data-recipient');
});

// mood labels behaviour
moodLabels.forEach(lbl => {
  lbl.addEventListener('click', () => {
    moodLabels.forEach(l => l.classList.remove('active'));
    lbl.classList.add('active');
    const val = lbl.dataset.mood;
    const radio = moodRadios.find(r => r.value === val);
    if (radio) radio.checked = true;
  });
});

function updatePreview(){
  const txt = txtBody.value.trim();
  preview.textContent = txt.length ? (txt.length > 1000 ? txt.slice(0,1000) + '…' : txt) : 'Your whisper preview...';
}
updatePreview();

function readLocal(){
  try {
    const raw = localStorage.getItem(KEY_LOCAL);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch(e){ return []; }
}
function saveLocal(post){
  const arr = readLocal();
  arr.unshift(post);
  try { localStorage.setItem(KEY_LOCAL, JSON.stringify(arr)); } catch(e){ console.warn('localStorage set failed', e); }
}

async function saveToFirestore(doc){
  const db = firebase.firestore();
  const coll = db.collection('whispers');
  // use server timestamp if available
  const toSave = Object.assign({}, doc);
  toSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
  const res = await coll.add(toSave);
  return res && res.id;
}

btnCancel.addEventListener('click', () => { window.location.href = 'whispers.html'; });

btnSave.addEventListener('click', async () => {
  const body = txtBody.value.trim();
  if (!body) { alert('Please write something before whispering.'); txtBody.focus(); return; }

  let recipient = customRecipient.value.trim();
  if (!recipient) {
    const activeBtn = recipientBtns.find(b => b.classList.contains('active'));
    recipient = activeBtn ? (activeBtn.dataset.recipient || activeBtn.textContent.trim()) : '—';
  }

  const moodInput = moodRadios.find(i => i.checked);
  const mood = moodInput ? moodInput.value : 'melancholy';
  const anonymous = !!chkAnon.checked;

  const doc = {
    recipient,
    text: body,
    mood,
    likes: 0,
    anonymous,
  };

  // Try Firestore -> fallback to local
  if (firestoreAvailable) {
    try {
      statusMsg.textContent = 'Posting…';
      const id = await saveToFirestore(doc);
      try { localStorage.setItem('unsent_last_added', String(id)); } catch(e){}
      statusMsg.textContent = 'Posted — redirecting…';
      setTimeout(()=> window.location.href = 'whispers.html', 600);
      return;
    } catch (err) {
      console.error('Firestore write failed:', err);
      statusMsg.textContent = 'Could not post publicly — saved locally.';
    }
  }

  // Save locally as fallback
  try {
    doc.id = Date.now();
    doc.createdAt = new Date().toISOString();
    saveLocal(doc);
    try { localStorage.setItem('unsent_last_added', String(doc.id)); } catch(e){}
    statusMsg.textContent = 'Saved locally — redirecting…';
    setTimeout(()=> window.location.href = 'whispers.html', 600);
  } catch (e) {
    console.error('Local save failed', e);
    alert('Failed to save your whisper. Please try again.');
  }
});

// Ctrl/Cmd + Enter to submit
txtBody.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    btnSave.click();
  }
});
</script>
</body>
</html>
